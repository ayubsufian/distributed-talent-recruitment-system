worker_processes 1;

events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;

    # -------------------------------------------------------------------------
    # UPSTREAM DEFINITIONS (Check service names match docker-compose.yml)
    # -------------------------------------------------------------------------
    upstream auth_backend { server auth-service:8000; }
    upstream job_backend  { server job-service:8000; }
    upstream app_backend  { server app-service:8000; }
    upstream notify_backend { server notify-service:8000; }
    upstream frontend_client { server frontend:80; }

    server {
        listen 80;
        server_name localhost;

        # 1. Auth Service (Identity & Users)
        location /auth {
            rewrite ^/auth/health /health break;
            rewrite ^/auth/docs /docs break;
            rewrite ^/auth/openapi.json /openapi.json break;

            proxy_pass http://auth_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        location /users {
            proxy_pass http://auth_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # 2. Job Service
        location /jobs {
            rewrite ^/jobs/health /health break;
            rewrite ^/jobs/docs /docs break;
            rewrite ^/jobs/openapi.json /openapi.json break;

            proxy_pass http://job_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # 3. Application Service
        location /applications {
            rewrite ^/applications/health /health break;
            rewrite ^/applications/docs /docs break;
            rewrite ^/applications/openapi.json /openapi.json break;

            proxy_pass http://app_backend;
            proxy_set_header Host $host;
            client_max_body_size 10M;
        }

        # 4. Notification Service
        location /notifications {
            rewrite ^/notifications/health /health break;
            rewrite ^/notifications/docs /docs break;
            rewrite ^/notifications/openapi.json /openapi.json break;

            proxy_pass http://notify_backend;
            proxy_set_header Host $host;
        }

        # 6. System Service
        location /system {
            proxy_pass http://notify_backend;
            proxy_set_header Host $host;
        }

        # 5. Frontend (React SPA)
        location / {
            proxy_pass http://frontend_client;
            proxy_set_header Host $host;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    }
}